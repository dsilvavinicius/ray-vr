__exported import DodecahedronGlobals;

shared cbuffer HyperbolicCB
{
    float gDodecahedronScale;
}

// Dodecahedron face definition.
/*struct Face
{
    float4x4 transform;
    float4x4 invTransform; // The inverse transform is a face-to-face map, given a discrete group of transformations.
    float3 normal;
};

static const float4x4 dodecahedronTransforms[12] =
{
    float4x4(
                0.8090169943749475, -0.8090169943749475, 1.8090169943749475, 1.8925008534508818,
                0.8090169943749475, -0.30901699437494745, -0.5, 0.0,
                1.8090169943749475, 0.5, 2.618033988749895, 3.0621307046217106,
                1.8925008534508818, 0.0, 3.0621307046217106, 3.73606797749979
            ),
            float4x4(
                0.8090169943749475, 0.8090169943749475, -1.8090169943749475, 1.8925008534508818,
                -0.8090169943749475, -0.30901699437494745, -0.5, 0.0,
                -1.8090169943749475, 0.5, 2.618033988749895, -3.0621307046217106,
                1.8925008534508818, 0.0, -3.0621307046217106, 3.73606797749979
            ),
            float4x4(
                0.8090169943749475, -0.8090169943749475, -1.8090169943749475, -1.8925008534508818,
                0.8090169943749475, -0.30901699437494745, 0.5, 0.0,
                -1.8090169943749475, -0.5, 2.618033988749895, 3.0621307046217106,
                -1.8925008534508818, 0.0, 3.0621307046217106, 3.73606797749979
            ),
            float4x4(
                0.8090169943749475, 0.8090169943749475, 1.8090169943749475, -1.8925008534508818,
                -0.8090169943749475, -0.30901699437494745, 0.5, 0.0,
                1.8090169943749475, -0.5, 2.618033988749895, -3.0621307046217106,
                -1.8925008534508818, 0.0, -3.0621307046217106, 3.73606797749979
            ),
            float4x4(
                -0.30901699437494745, -0.5, 0.8090169943749475, 0.0,
                0.5, 2.618033988749895, 1.8090169943749475, 3.0621307046217106,
                -0.8090169943749475, 1.8090169943749475, 0.8090169943749475, 1.8925008534508818,
                0.0, 3.0621307046217106, 1.8925008534508818, 3.73606797749979
            ),
            float4x4(
                -0.30901699437494745, 0.5, 0.8090169943749475, 0.0,
                -0.5, 2.618033988749895, -1.8090169943749475, 3.0621307046217106,
                -0.8090169943749475, -1.8090169943749475, 0.8090169943749475, -1.8925008534508818,
                0.0, 3.0621307046217106, -1.8925008534508818, 3.73606797749979
            ),
            float4x4(
                -0.30901699437494745, -0.5, -0.8090169943749475, 0.0,
                0.5, 2.618033988749895, -1.8090169943749475, -3.0621307046217106,
                0.8090169943749475, -1.8090169943749475, 0.8090169943749475, 1.8925008534508818,
                0.0, -3.0621307046217106, 1.8925008534508818, 3.73606797749979
            ),
            float4x4(
                -0.30901699437494745, 0.5, -0.8090169943749475, 0.0,
                -0.5, 2.618033988749895, 1.8090169943749475, -3.0621307046217106,
                0.8090169943749475, 1.8090169943749475, 0.8090169943749475, -1.8925008534508818,
                0.0, -3.0621307046217106, -1.8925008534508818, 3.73606797749979
            ),
            float4x4(
                2.618033988749895, 1.8090169943749475, 0.5, 3.0621307046217106,
                1.8090169943749475, 0.8090169943749475, -0.8090169943749475, 1.8925008534508818,
                -0.5, 0.8090169943749475, -0.30901699437494745, 0.0,
                3.0621307046217106, 1.8925008534508818, 0.0, 3.73606797749979
            ),
            float4x4(
                2.618033988749895, -1.8090169943749475, 0.5, -3.0621307046217106,
                -1.8090169943749475, 0.8090169943749475, 0.8090169943749475, 1.8925008534508818,
                -0.5, -0.8090169943749475, -0.30901699437494745, 0.0,
                -3.0621307046217106, 1.8925008534508818, 0.0, 3.73606797749979
            ),
            float4x4(
                2.618033988749895, -1.8090169943749475, -0.5, 3.0621307046217106,
                -1.8090169943749475, 0.8090169943749475, -0.8090169943749475, -1.8925008534508818,
                0.5, 0.8090169943749475, -0.30901699437494745, 0.0,
                3.0621307046217106, -1.8925008534508818, 0.0, 3.73606797749979
            ),
            float4x4(
                2.618033988749895, 1.8090169943749475, -0.5, -3.0621307046217106,
                1.8090169943749475, 0.8090169943749475, 0.8090169943749475, -1.8925008534508818,
                0.5, -0.8090169943749475, -0.30901699437494745, 0.0,
                -3.0621307046217106, -1.8925008534508818, 0.0, 3.73606797749979
            )
};*/

/*static const float3 dodecahedronNormals[12] =
{
    float3(0.3995932622677323, 0.0, 0.6465554800246417),
    float3(0.3995932622677323, 0.0, -0.6465554800246417),
    float3(-0.3995932622677323, 0.0, 0.6465554800246417),
    float3(-0.3995932622677323, 0.0, -0.6465554800246417),
    float3(0.0, 0.6465554800246417, 0.3995932622677323),
    float3(0.0, 0.6465554800246417, -0.3995932622677323),
    float3(0.0, -0.6465554800246417, 0.3995932622677323),
    float3(0.0, -0.6465554800246417, -0.3995932622677323),
    float3(0.6465554800246417, 0.3995932622677323, 0.0),
    float3(-0.6465554800246417, 0.3995932622677323, 0.0),
    float3(0.6465554800246417, -0.3995932622677323, 0.0),
    float3(-0.6465554800246417, -0.3995932622677323, 0.0)
};

static const Face gFaces[12] =
{
    {
        float4x4(
            0.8090169943749475, -0.8090169943749475, 1.8090169943749475, 1.8925008534508818,
            0.8090169943749475, -0.30901699437494745, -0.5, 0.0,
            1.8090169943749475, 0.5, 2.618033988749895, 3.0621307046217106,
            1.8925008534508818, 0.0, 3.0621307046217106, 3.73606797749979
        ),
        float4x4(
            0.8090169943749468, 0.8090169943749475, 1.8090169943749477, -1.8925008534508811,
            -0.8090169943749473, -0.3090169943749474, 0.49999999999999994, -2.7446222572442327e-16,
            1.8090169943749475, -0.5, 2.618033988749895, -3.062130704621711,
            -1.8925008534508816, -0.0, -3.0621307046217106, 3.73606797749979
        ),
        float3(
            0.3995932622677323, 0.0, 0.6465554800246417
        )
    },
    {
        float4x4(
            0.8090169943749475, 0.8090169943749475, -1.8090169943749475, 1.8925008534508818,
            -0.8090169943749475, -0.30901699437494745, -0.5, 0.0,
            -1.8090169943749475, 0.5, 2.618033988749895, -3.0621307046217106,
            1.8925008534508818, 0.0, -3.0621307046217106, 3.73606797749979
        ),
        float4x4(
            0.8090169943749468, -0.8090169943749475, -1.8090169943749477, -1.8925008534508811,
            0.8090169943749473, -0.3090169943749474, 0.49999999999999994, 2.7446222572442327e-16,
            -1.8090169943749475, -0.5, 2.618033988749895, 3.062130704621711,
            -1.8925008534508816, 0.0, 3.0621307046217106, 3.73606797749979
        ),
        float3(
            0.3995932622677323, 0.0, -0.6465554800246417
        )
    },
    {
        float4x4(
            0.8090169943749475, -0.8090169943749475, -1.8090169943749475, -1.8925008534508818,
            0.8090169943749475, -0.30901699437494745, 0.5, 0.0,
            -1.8090169943749475, -0.5, 2.618033988749895, 3.0621307046217106,
            -1.8925008534508818, 0.0, 3.0621307046217106, 3.73606797749979
        ),
        float4x4(
            0.8090169943749468, 0.8090169943749475, -1.8090169943749477, 1.8925008534508811,
            -0.8090169943749473, -0.3090169943749474, -0.49999999999999994, 2.7446222572442327e-16,
            -1.8090169943749475, 0.5, 2.618033988749895, -3.062130704621711,
            1.8925008534508816, -0.0, -3.0621307046217106, 3.73606797749979
        ),
        float3(
            -0.3995932622677323, 0.0, 0.6465554800246417
        )
    },
    {
        float4x4(
            0.8090169943749475, 0.8090169943749475, 1.8090169943749475, -1.8925008534508818,
            -0.8090169943749475, -0.30901699437494745, 0.5, 0.0,
            1.8090169943749475, -0.5, 2.618033988749895, -3.0621307046217106,
            -1.8925008534508818, 0.0, -3.0621307046217106, 3.73606797749979
        ),
        float4x4(
            0.8090169943749468, -0.8090169943749475, 1.8090169943749477, 1.8925008534508811,
            0.8090169943749473, -0.3090169943749474, -0.49999999999999994, -2.7446222572442327e-16,
            1.8090169943749475, 0.5, 2.618033988749895, 3.062130704621711,
            1.8925008534508816, 0.0, 3.0621307046217106, 3.73606797749979
        ),
        float3(
            -0.3995932622677323, 0.0, -0.6465554800246417
        )
    },
    {
        float4x4(
            -0.30901699437494745, -0.5, 0.8090169943749475, 0.0,
            0.5, 2.618033988749895, 1.8090169943749475, 3.0621307046217106,
            -0.8090169943749475, 1.8090169943749475, 0.8090169943749475, 1.8925008534508818,
            0.0, 3.0621307046217106, 1.8925008534508818, 3.73606797749979
        ),
        float4x4(
            -0.3090169943749474, 0.49999999999999944, -0.8090169943749473, 2.195697805795386e-15,
            -0.5, 2.6180339887498874, 1.809016994374943, -3.0621307046217012,
            0.8090169943749475, 1.8090169943749426, 0.8090169943749443, -1.8925008534508758,
            0.0, -3.0621307046217017, -1.8925008534508765, 3.736067977499779
        ),
        float3(
            0.0, 0.6465554800246417, 0.3995932622677323
        )
    },
    {
        float4x4(
            -0.30901699437494745, 0.5, 0.8090169943749475, 0.0,
            -0.5, 2.618033988749895, -1.8090169943749475, 3.0621307046217106,
            -0.8090169943749475, -1.8090169943749475, 0.8090169943749475, -1.8925008534508818,
            0.0, 3.0621307046217106, -1.8925008534508818, 3.73606797749979
        ),
        float4x4(
            -0.3090169943749474, -0.49999999999999944, -0.8090169943749473, -2.195697805795386e-15,
            0.5, 2.6180339887498874, -1.809016994374943, -3.0621307046217012,
            0.8090169943749475, -1.8090169943749426, 0.8090169943749443, 1.8925008534508758,
            0.0, -3.0621307046217017, 1.8925008534508765, 3.736067977499779
        ),
        float3(
            0.0, 0.6465554800246417, -0.3995932622677323
        )
    },
    {
        float4x4(
            -0.30901699437494745, -0.5, -0.8090169943749475, 0.0,
            0.5, 2.618033988749895, -1.8090169943749475, -3.0621307046217106,
            0.8090169943749475, -1.8090169943749475, 0.8090169943749475, 1.8925008534508818,
            0.0, -3.0621307046217106, 1.8925008534508818, 3.73606797749979
        ),
        float4x4(
            -0.3090169943749474, 0.49999999999999944, 0.8090169943749473, -2.195697805795386e-15,
            -0.5, 2.6180339887498874, -1.809016994374943, 3.0621307046217012,
            -0.8090169943749475, -1.8090169943749426, 0.8090169943749443, -1.8925008534508758,
            0.0, 3.0621307046217017, -1.8925008534508765, 3.736067977499779
        ),
        float3(
            0.0, -0.6465554800246417, 0.3995932622677323
        )
    },
    {
        float4x4(
            -0.30901699437494745, 0.5, -0.8090169943749475, 0.0,
            -0.5, 2.618033988749895, 1.8090169943749475, -3.0621307046217106,
            0.8090169943749475, 1.8090169943749475, 0.8090169943749475, -1.8925008534508818,
            0.0, -3.0621307046217106, -1.8925008534508818, 3.73606797749979
        ),
        float4x4(
            -0.3090169943749474, -0.49999999999999944, 0.8090169943749473, 2.195697805795386e-15,
            0.5, 2.6180339887498874, 1.809016994374943, 3.0621307046217012,
            -0.8090169943749475, 1.8090169943749426, 0.8090169943749443, 1.8925008534508758,
            0.0, 3.0621307046217017, 1.8925008534508765, 3.736067977499779
        ),
        float3(
            0.0, -0.6465554800246417, -0.3995932622677323
        )
    },
    {
        float4x4(
            2.618033988749895, 1.8090169943749475, 0.5, 3.0621307046217106,
            1.8090169943749475, 0.8090169943749475, -0.8090169943749475, 1.8925008534508818,
            -0.5, 0.8090169943749475, -0.30901699437494745, 0.0,
            3.0621307046217106, 1.8925008534508818, 0.0, 3.73606797749979
        ),
        float4x4(
            2.618033988749891, 1.8090169943749452, -0.5000000000000007, -3.0621307046217066,
            1.8090169943749455, 0.8090169943749462, 0.8090169943749469, -1.8925008534508792,
            0.5000000000000004, -0.8090169943749472, -0.30901699437494734, -6.206335383118183e-16,
            -3.0621307046217066, -1.8925008534508796, 8.499120031706682e-16, 3.7360679774997854
        ),
        float3(
            0.6465554800246417, 0.3995932622677323, 0.0
        )
    },
    {
        float4x4(
            2.618033988749895, -1.8090169943749475, 0.5, -3.0621307046217106,
            -1.8090169943749475, 0.8090169943749475, 0.8090169943749475, 1.8925008534508818,
            -0.5, -0.8090169943749475, -0.30901699437494745, 0.0,
            -3.0621307046217106, 1.8925008534508818, 0.0, 3.73606797749979
        ),
        float4x4(
            2.618033988749891, -1.8090169943749452, -0.5000000000000007, 3.0621307046217066,
            -1.8090169943749455, 0.8090169943749462, -0.8090169943749469, -1.8925008534508792,
            0.5000000000000004, 0.8090169943749472, -0.30901699437494734, 6.206335383118183e-16,
            3.0621307046217066, -1.8925008534508796, -8.499120031706682e-16, 3.7360679774997854
        ),
        float3(
            -0.6465554800246417, 0.3995932622677323, 0.0
        )
    },
    {
        float4x4(
            2.618033988749895, -1.8090169943749475, -0.5, 3.0621307046217106,
            -1.8090169943749475, 0.8090169943749475, -0.8090169943749475, -1.8925008534508818,
            0.5, 0.8090169943749475, -0.30901699437494745, 0.0,
            3.0621307046217106, -1.8925008534508818, 0.0, 3.73606797749979
        ),
        float4x4(
            2.618033988749891, -1.8090169943749452, 0.5000000000000007, -3.0621307046217066,
            -1.8090169943749455, 0.8090169943749462, 0.8090169943749469, 1.8925008534508792,
            -0.5000000000000004, -0.8090169943749472, -0.30901699437494734, 6.206335383118183e-16,
            -3.0621307046217066, 1.8925008534508796, -8.499120031706682e-16, 3.7360679774997854
        ),
        float3(
            0.6465554800246417, -0.3995932622677323, 0.0
        )
    },
    {
        float4x4(
            2.618033988749895, 1.8090169943749475, -0.5, -3.0621307046217106,
            1.8090169943749475, 0.8090169943749475, 0.8090169943749475, -1.8925008534508818,
            0.5, -0.8090169943749475, -0.30901699437494745, 0.0,
            -3.0621307046217106, -1.8925008534508818, 0.0, 3.73606797749979
        ),
        float4x4(
            2.618033988749891, 1.8090169943749452, 0.5000000000000007, 3.0621307046217066,
            1.8090169943749455, 0.8090169943749462, -0.8090169943749469, 1.8925008534508792,
            -0.5000000000000004, 0.8090169943749472, -0.30901699437494734, -6.206335383118183e-16,
            3.0621307046217066, 1.8925008534508796, 8.499120031706682e-16, 3.7360679774997854
        ),
        float3(
            -0.6465554800246417, -0.3995932622677323, 0.0
        )
    }
};*/

float hgeo_doth(float4 A, float4 B)
{
    return A.w * B.w - A.x * B.x - A.y * B.y - A.z * B.z;
}

float hgeo_Q(float4 X)
{
    return hgeo_doth(X, X);
}

float4 hgeo_euc2hip(float3 X)
{
    float4 Xbar = float4(X.xyz, 1.0);
    float4 Xhat = Xbar / sqrt(hgeo_Q(Xbar));
    return Xhat;
}


// Projection of the vector u to the tangent space in X using Minkowski metric (https://en.wikipedia.org/wiki/Minkowski_space)
float4 hgeo_diff_euc2hip(float3 X, float3 u)
{
    float4 Xbar = float4(X, 1.0);
    float4 ubar = float4(u, 0.0);
    return ((ubar / sqrt(hgeo_Q(Xbar)))
          - Xbar * hgeo_doth(ubar, Xbar) / (sqrt(hgeo_Q(Xbar)) * hgeo_Q(Xbar)));
}

float3 hgeo_hip2euc(float4 Xhat)
{
    float4 Xbar = Xhat / Xhat.w;
    float3 X = Xbar.xyz;
    return X;
}


// Computes the direction in the Klein model given a tangent direction in the parabolid.
// That is, the direction provided by the intersection between the plane z=1 and the plane spanned by Xhat and uhat
float3 hgeo_diff_hip2euc(float4 Xhat, float4 uhat)
{
    return uhat.xyz / Xhat.w + float3(-Xhat.x * uhat.w, -Xhat.y * uhat.w, -Xhat.z * uhat.w) / (Xhat.w * Xhat.w); //diff p em x aplicado em uhat
}

struct Ray
{
    float3 origin;
    float3 dir;
    //bool sanityCheck;
};


Ray func_new_ray_direction(
      in float4x4 A, //plane matrix
      in float3 ray_intersection, //hitpos
      in float3 ray_n //ray dir
)
{
    float4 Xhat = hgeo_euc2hip(ray_intersection);
    float4 Yhat = mul(Xhat, A); //carefull matrix mult*********************************
    float4 Vhat = hgeo_diff_euc2hip(ray_intersection, ray_n);
    float4 What = mul(Vhat, A); //carefull matrix mult*********************************

    Ray ray;
    ray.origin = hgeo_hip2euc(Yhat);
    ray.dir = hgeo_diff_hip2euc(Yhat, What);
    /*ray.sanityCheck = true;

    // Debug
    {
        float epsilon = 0.1;
        float len = length(ray_intersection);
        //ray.sanityCheck = (abs(1.f - sqrt(hgeo_Q(Xhat))) < epsilon);
        ray.sanityCheck = (len <= 1.f);
    }*/

    return ray;
}



float doth(float4 A, float4 B)
{
    return -A.w * B.w + A.x * B.x + A.y * B.y + A.z * B.z;
}

float dote(float3 A, float3 B)
{
    return A.x * B.x + A.y * B.y + A.z * B.z;
}

float distH(float4 p, float4 q)
{
    float x = sqrt((doth(p, q) * doth(p, q)) / (doth(p, p) * doth(q, q)));

    return 2 * log(x + sqrt(x*x-1));
}

Ray perfectReflection(
      in float4 N, //dodecahedron face barycenter in homogeneus coordinates
      in float3 p, //hitpos
      in float3 v  //ray dir
)
{
    //barycenter in Klein model coordinates
    float3 q = float3(N.xyz) / (N.w + 1); 

    float q_dote = dote(q, q);

    float3 n = q / sqrt(q_dote);

    //parameter that gives the intersection between the ray origin + t*p and the face 
    //0.87 ajustes to the right-angle dodecahedron in Klein model
    float t = (q_dote / dote(p, q))*gDodecahedronScale;

    p = t * p;
    q = t * q;

    float4 hp = float4(p-0.5*v, 1.f);
    
    float4 hq = float4(q, q_dote*t*t);

    float4 Rhp = hp - 2.f * hq * (doth(hq, hp)) / (doth(hq, hq));
  
    float3 Rp = float3(Rhp.xyz)/Rhp.w;
    
    float3 new_dir = p - Rp;
    
    Ray ray;
    ray.origin = p / t;
    ray.dir = new_dir;
    
    return ray;
}