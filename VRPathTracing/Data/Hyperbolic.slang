#ifndef HYPERBOLIC
#define HYPERBOLIC

// Dodecahedron face definition.
struct Face
{
    float4x4 transform;
    float4x4 invTransform; // The inverse transform is a face-to-face map, given a discrete group of transformations.
    float3 normal;
};

static const Face gFaces[12] =
{
    {
        float4x4(
            0.8090169943749475, -0.8090169943749475, 1.8090169943749475, 1.8925008534508818,
            0.8090169943749475, -0.30901699437494745, -0.5, 0.0,
            1.8090169943749475, 0.5, 2.618033988749895, 3.0621307046217106,
            1.8925008534508818, 0.0, 3.0621307046217106, 3.73606797749979
        ),
        float4x4(
            0.8090169943749468, 0.8090169943749475, 1.8090169943749477, -1.8925008534508811,
            -0.8090169943749473, -0.3090169943749474, 0.49999999999999994, -2.7446222572442327e-16,
            1.8090169943749475, -0.5, 2.618033988749895, -3.062130704621711,
            -1.8925008534508816, -0.0, -3.0621307046217106, 3.73606797749979
        ),
        float3(
            0.3995932622677323, 0.0, 0.6465554800246417
        )
    },
    {
        float4x4(
            0.8090169943749475, 0.8090169943749475, -1.8090169943749475, 1.8925008534508818,
            -0.8090169943749475, -0.30901699437494745, -0.5, 0.0,
            -1.8090169943749475, 0.5, 2.618033988749895, -3.0621307046217106,
            1.8925008534508818, 0.0, -3.0621307046217106, 3.73606797749979
        ),
        float4x4(
            0.8090169943749468, -0.8090169943749475, -1.8090169943749477, -1.8925008534508811,
            0.8090169943749473, -0.3090169943749474, 0.49999999999999994, 2.7446222572442327e-16,
            -1.8090169943749475, -0.5, 2.618033988749895, 3.062130704621711,
            -1.8925008534508816, 0.0, 3.0621307046217106, 3.73606797749979
        ),
        float3(
            0.3995932622677323, 0.0, -0.6465554800246417
        )
    },
    {
        float4x4(
            0.8090169943749475, -0.8090169943749475, -1.8090169943749475, -1.8925008534508818,
            0.8090169943749475, -0.30901699437494745, 0.5, 0.0,
            -1.8090169943749475, -0.5, 2.618033988749895, 3.0621307046217106,
            -1.8925008534508818, 0.0, 3.0621307046217106, 3.73606797749979
        ),
        float4x4(
            0.8090169943749468, 0.8090169943749475, -1.8090169943749477, 1.8925008534508811,
            -0.8090169943749473, -0.3090169943749474, -0.49999999999999994, 2.7446222572442327e-16,
            -1.8090169943749475, 0.5, 2.618033988749895, -3.062130704621711,
            1.8925008534508816, -0.0, -3.0621307046217106, 3.73606797749979
        ),
        float3(
            -0.3995932622677323, 0.0, 0.6465554800246417
        )
    },
    {
        float4x4(
            0.8090169943749475, 0.8090169943749475, 1.8090169943749475, -1.8925008534508818,
            -0.8090169943749475, -0.30901699437494745, 0.5, 0.0,
            1.8090169943749475, -0.5, 2.618033988749895, -3.0621307046217106,
            -1.8925008534508818, 0.0, -3.0621307046217106, 3.73606797749979
        ),
        float4x4(
            0.8090169943749468, -0.8090169943749475, 1.8090169943749477, 1.8925008534508811,
            0.8090169943749473, -0.3090169943749474, -0.49999999999999994, -2.7446222572442327e-16,
            1.8090169943749475, 0.5, 2.618033988749895, 3.062130704621711,
            1.8925008534508816, 0.0, 3.0621307046217106, 3.73606797749979
        ),
        float3(
            -0.3995932622677323, 0.0, -0.6465554800246417
        )
    },
    {
        float4x4(
            -0.30901699437494745, -0.5, 0.8090169943749475, 0.0,
            0.5, 2.618033988749895, 1.8090169943749475, 3.0621307046217106,
            -0.8090169943749475, 1.8090169943749475, 0.8090169943749475, 1.8925008534508818,
            0.0, 3.0621307046217106, 1.8925008534508818, 3.73606797749979
        ),
        float4x4(
            -0.3090169943749474, 0.49999999999999944, -0.8090169943749473, 2.195697805795386e-15,
            -0.5, 2.6180339887498874, 1.809016994374943, -3.0621307046217012,
            0.8090169943749475, 1.8090169943749426, 0.8090169943749443, -1.8925008534508758,
            0.0, -3.0621307046217017, -1.8925008534508765, 3.736067977499779
        ),
        float3(
            0.0, 0.6465554800246417, 0.3995932622677323
        )
    },
    {
        float4x4(
            -0.30901699437494745, 0.5, 0.8090169943749475, 0.0,
            -0.5, 2.618033988749895, -1.8090169943749475, 3.0621307046217106,
            -0.8090169943749475, -1.8090169943749475, 0.8090169943749475, -1.8925008534508818,
            0.0, 3.0621307046217106, -1.8925008534508818, 3.73606797749979
        ),
        float4x4(
            -0.3090169943749474, -0.49999999999999944, -0.8090169943749473, -2.195697805795386e-15,
            0.5, 2.6180339887498874, -1.809016994374943, -3.0621307046217012,
            0.8090169943749475, -1.8090169943749426, 0.8090169943749443, 1.8925008534508758,
            0.0, -3.0621307046217017, 1.8925008534508765, 3.736067977499779
        ),
        float3(
            0.0, 0.6465554800246417, -0.3995932622677323
        )
    },
    {
        float4x4(
            -0.30901699437494745, -0.5, -0.8090169943749475, 0.0,
            0.5, 2.618033988749895, -1.8090169943749475, -3.0621307046217106,
            0.8090169943749475, -1.8090169943749475, 0.8090169943749475, 1.8925008534508818,
            0.0, -3.0621307046217106, 1.8925008534508818, 3.73606797749979
        ),
        float4x4(
            -0.3090169943749474, 0.49999999999999944, 0.8090169943749473, -2.195697805795386e-15,
            -0.5, 2.6180339887498874, -1.809016994374943, 3.0621307046217012,
            -0.8090169943749475, -1.8090169943749426, 0.8090169943749443, -1.8925008534508758,
            0.0, 3.0621307046217017, -1.8925008534508765, 3.736067977499779
        ),
        float3(
            0.0, -0.6465554800246417, 0.3995932622677323
        )
    },
    {
        float4x4(
            -0.30901699437494745, 0.5, -0.8090169943749475, 0.0,
            -0.5, 2.618033988749895, 1.8090169943749475, -3.0621307046217106,
            0.8090169943749475, 1.8090169943749475, 0.8090169943749475, -1.8925008534508818,
            0.0, -3.0621307046217106, -1.8925008534508818, 3.73606797749979
        ),
        float4x4(
            -0.3090169943749474, -0.49999999999999944, 0.8090169943749473, 2.195697805795386e-15,
            0.5, 2.6180339887498874, 1.809016994374943, 3.0621307046217012,
            -0.8090169943749475, 1.8090169943749426, 0.8090169943749443, 1.8925008534508758,
            0.0, 3.0621307046217017, 1.8925008534508765, 3.736067977499779
        ),
        float3(
            0.0, -0.6465554800246417, -0.3995932622677323
        )
    },
    {
        float4x4(
            2.618033988749895, 1.8090169943749475, 0.5, 3.0621307046217106,
            1.8090169943749475, 0.8090169943749475, -0.8090169943749475, 1.8925008534508818,
            -0.5, 0.8090169943749475, -0.30901699437494745, 0.0,
            3.0621307046217106, 1.8925008534508818, 0.0, 3.73606797749979
        ),
        float4x4(
            2.618033988749891, 1.8090169943749452, -0.5000000000000007, -3.0621307046217066,
            1.8090169943749455, 0.8090169943749462, 0.8090169943749469, -1.8925008534508792,
            0.5000000000000004, -0.8090169943749472, -0.30901699437494734, -6.206335383118183e-16,
            -3.0621307046217066, -1.8925008534508796, 8.499120031706682e-16, 3.7360679774997854
        ),
        float3(
            0.6465554800246417, 0.3995932622677323, 0.0
        )
    },
    {
        float4x4(
            2.618033988749895, -1.8090169943749475, 0.5, -3.0621307046217106,
            -1.8090169943749475, 0.8090169943749475, 0.8090169943749475, 1.8925008534508818,
            -0.5, -0.8090169943749475, -0.30901699437494745, 0.0,
            -3.0621307046217106, 1.8925008534508818, 0.0, 3.73606797749979
        ),
        float4x4(
            2.618033988749891, -1.8090169943749452, -0.5000000000000007, 3.0621307046217066,
            -1.8090169943749455, 0.8090169943749462, -0.8090169943749469, -1.8925008534508792,
            0.5000000000000004, 0.8090169943749472, -0.30901699437494734, 6.206335383118183e-16,
            3.0621307046217066, -1.8925008534508796, -8.499120031706682e-16, 3.7360679774997854
        ),
        float3(
            -0.6465554800246417, 0.3995932622677323, 0.0
        )
    },
    {
        float4x4(
            2.618033988749895, -1.8090169943749475, -0.5, 3.0621307046217106,
            -1.8090169943749475, 0.8090169943749475, -0.8090169943749475, -1.8925008534508818,
            0.5, 0.8090169943749475, -0.30901699437494745, 0.0,
            3.0621307046217106, -1.8925008534508818, 0.0, 3.73606797749979
        ),
        float4x4(
            2.618033988749891, -1.8090169943749452, 0.5000000000000007, -3.0621307046217066,
            -1.8090169943749455, 0.8090169943749462, 0.8090169943749469, 1.8925008534508792,
            -0.5000000000000004, -0.8090169943749472, -0.30901699437494734, 6.206335383118183e-16,
            -3.0621307046217066, 1.8925008534508796, -8.499120031706682e-16, 3.7360679774997854
        ),
        float3(
            0.6465554800246417, -0.3995932622677323, 0.0
        )
    },
    {
        float4x4(
            2.618033988749895, 1.8090169943749475, -0.5, -3.0621307046217106,
            1.8090169943749475, 0.8090169943749475, 0.8090169943749475, -1.8925008534508818,
            0.5, -0.8090169943749475, -0.30901699437494745, 0.0,
            -3.0621307046217106, -1.8925008534508818, 0.0, 3.73606797749979
        ),
        float4x4(
            2.618033988749891, 1.8090169943749452, 0.5000000000000007, 3.0621307046217066,
            1.8090169943749455, 0.8090169943749462, -0.8090169943749469, 1.8925008534508792,
            -0.5000000000000004, 0.8090169943749472, -0.30901699437494734, -6.206335383118183e-16,
            3.0621307046217066, 1.8925008534508796, 8.499120031706682e-16, 3.7360679774997854
        ),
        float3(
            -0.6465554800246417, -0.3995932622677323, 0.0
        )
    }
};

float hgeo_doth(float4 A, float4 B)
{
    return A.w * B.w - A.x * B.x - A.y * B.y - A.z * B.z;
}

float hgeo_Q(float4 X)
{
    return hgeo_doth(X, X);
}

float4 hgeo_euc2hip(float3 X)
{
    float4 Xbar = float4(X.xyz, 1.0);
    float4 Xhat = Xbar / sqrt(hgeo_Q(Xbar));
    return Xhat;
}

float4 hgeo_diff_euc2hip(float3 X, float3 u)
{
    float4 Xbar = float4(X, 1.0);
    float4 ubar = float4(u, 0.0);
    return ((ubar / sqrt(hgeo_Q(Xbar)))
          - Xbar * hgeo_doth(ubar, Xbar) / (sqrt(hgeo_Q(Xbar)) * hgeo_Q(Xbar)));
}

float3 hgeo_hip2euc(float4 Xhat)
{
    float4 Xbar = Xhat / Xhat.w;
    float3 X = Xbar.xyz;
    return X;
}

float3 hgeo_diff_hip2euc(float4 Xhat, float4 uhat)
{
    return uhat.xyz / Xhat.w + float3(-Xhat.x * uhat.w, -Xhat.y * uhat.w, -Xhat.z * uhat.w) / (Xhat.w * Xhat.w); //diff p em x aplicado em uhat
}

struct Ray
{
    float3 origin;
    float3 dir;
    //bool sanityCheck;
};

Ray func_new_ray_direction(
      in float4x4 A, //plane matrix
      in float3 ray_intersection, //hitpos
      in float3 ray_n //ray dir
)
{
    float4 Xhat = hgeo_euc2hip(ray_intersection);
    float4 Yhat = mul(Xhat, A); //carefull matrix mult*********************************
    float4 Vhat = hgeo_diff_euc2hip(ray_intersection, ray_n);
    float4 What = mul(Vhat, A); //carefull matrix mult*********************************

    Ray ray;
    ray.origin = hgeo_hip2euc(Yhat);
    ray.dir = hgeo_diff_hip2euc(Yhat, What);
    /*ray.sanityCheck = true;

    // Debug
    {
        float epsilon = 0.1;
        float len = length(ray_intersection);
        //ray.sanityCheck = (abs(1.f - sqrt(hgeo_Q(Xhat))) < epsilon);
        ray.sanityCheck = (len <= 1.f);
    }*/

    return ray;
}

#endif